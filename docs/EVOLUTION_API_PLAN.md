# üìã PLANO DE IMPLEMENTA√á√ÉO - EVOLUTION API

## üéØ **VIS√ÉO GERAL DO PROJETO**

Integra√ß√£o completa da [Evolution API v2](https://doc.evolution-api.com/v2/pt/get-started/introduction) com o Dashboard IPTV, utilizando a inst√¢ncia em `https://evo.qpainel.com.br/`.

### **Objetivos Principais:**
- ‚úÖ Configura√ß√£o da Evolution API pelo Admin Supremo
- ‚úÖ Gerenciamento de inst√¢ncias WhatsApp
- ‚úÖ Templates de mensagens (texto e imagem)
- ‚úÖ Envio autom√°tico de notifica√ß√µes de vencimento
- ‚úÖ Envio manual para clientes espec√≠ficos
- ‚úÖ Isolamento completo do dashboard do cliente

### **P√∫blico-Alvo:**
- **Admin Supremo (ID = 1)**: Acesso total √†s funcionalidades
- **Clientes**: Sem acesso ou visualiza√ß√£o (isolamento completo)

---

## üóÇÔ∏è **ESTRUTURA DE IMPLEMENTA√á√ÉO**

### **FASE 1: CONFIGURA√á√ÉO BASE E INFRAESTRUTURA**

#### 1.1 Extens√£o do Sistema de Configura√ß√µes
**Arquivo**: `lib/configuracoes.ts`

**Configura√ß√µes a Adicionar:**
```sql
INSERT INTO configuracoes (chave, valor, descricao) VALUES
('evolution_api_url', '', 'URL da Evolution API (ex: https://evo.qpainel.com.br)'),
('evolution_api_key', '', 'API Key global da Evolution API');
```

#### 1.2 Cria√ß√£o de Tabelas no Banco de Dados

**Tabela: `evolution_instancias`**
```sql
CREATE TABLE evolution_instancias (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(100) NOT NULL COMMENT 'Nome amig√°vel da inst√¢ncia',
  instance_name VARCHAR(100) NOT NULL UNIQUE COMMENT 'Nome t√©cnico na Evolution',
  status ENUM('criando', 'desconectada', 'conectada', 'erro') DEFAULT 'criando',
  qr_code TEXT COMMENT 'QR Code em base64',
  api_key VARCHAR(255) COMMENT 'API Key espec√≠fica da inst√¢ncia',
  webhook_url VARCHAR(255) COMMENT 'URL do webhook configurado',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Tabela: `message_templates`**
```sql
CREATE TABLE message_templates (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(100) NOT NULL COMMENT 'Nome do template',
  tipo ENUM('vencimento', 'pagamento', 'boas_vindas', 'manutencao', 'personalizada') NOT NULL,
  message_type ENUM('texto', 'imagem') NOT NULL DEFAULT 'texto',
  assunto VARCHAR(200) COMMENT 'Assunto/t√≠tulo do template',
  mensagem TEXT NOT NULL COMMENT 'Texto da mensagem com vari√°veis',
  imagem_url VARCHAR(500) COMMENT 'URL da imagem (quando message_type = imagem)',
  imagem_caption TEXT COMMENT 'Legenda da imagem com vari√°veis',
  ativo BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Tabela: `message_history`**
```sql
CREATE TABLE message_history (
  id INT AUTO_INCREMENT PRIMARY KEY,
  cliente_id INT NOT NULL,
  instancia_id INT NOT NULL,
  template_id INT,
  numero_whatsapp VARCHAR(20) NOT NULL,
  message_type ENUM('texto', 'imagem') NOT NULL,
  mensagem_enviada TEXT NOT NULL,
  imagem_enviada VARCHAR(500) COMMENT 'URL da imagem enviada',
  status ENUM('enviando', 'enviada', 'erro', 'lida') DEFAULT 'enviando',
  response_data JSON COMMENT 'Resposta da Evolution API',
  error_message TEXT COMMENT 'Mensagem de erro se houver',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (cliente_id) REFERENCES clientes(id) ON DELETE CASCADE,
  FOREIGN KEY (instancia_id) REFERENCES evolution_instancias(id) ON DELETE CASCADE,
  FOREIGN KEY (template_id) REFERENCES message_templates(id) ON DELETE SET NULL
);
```

#### 1.3 Middleware de Seguran√ßa
**Arquivo**: `lib/admin-middleware.ts`

Verifica√ß√£o obrigat√≥ria para todas as rotas Evolution:
- Usu√°rio logado
- Tipo = 'admin'
- ID = 1 (admin supremo)

---

### **FASE 2: BACKEND - COMUNICA√á√ÉO COM EVOLUTION API**

#### 2.1 Servi√ßo de Comunica√ß√£o
**Arquivo**: `lib/evolution-api.ts`

**M√©todos a Implementar:**
```typescript
class EvolutionAPIService {
  // Configura√ß√£o
  async testConnection(): Promise<boolean>
  
  // Inst√¢ncias
  async createInstance(instanceName: string): Promise<any>
  async getInstanceStatus(instanceName: string): Promise<any>
  async getQRCode(instanceName: string): Promise<string>
  async deleteInstance(instanceName: string): Promise<boolean>
  
  // Mensagens
  async sendTextMessage(instanceName: string, number: string, text: string): Promise<any>
  async sendImageMessage(instanceName: string, number: string, imageUrl: string, caption?: string): Promise<any>
  
  // Webhook
  async setWebhook(instanceName: string, webhookUrl: string): Promise<boolean>
}
```

#### 2.2 APIs do Sistema

**`/api/evolution/config/route.ts`**
- GET: Buscar configura√ß√µes da Evolution API
- PUT: Atualizar configura√ß√µes
- POST: Testar conex√£o

**`/api/evolution/instances/route.ts`**
- GET: Listar inst√¢ncias
- POST: Criar nova inst√¢ncia

**`/api/evolution/instances/[id]/route.ts`**
- GET: Detalhes da inst√¢ncia
- DELETE: Excluir inst√¢ncia

**`/api/evolution/instances/[id]/qr/route.ts`**
- GET: Obter QR Code da inst√¢ncia

**`/api/evolution/instances/[id]/status/route.ts`**
- GET: Status atual da inst√¢ncia

**`/api/evolution/templates/route.ts`**
- GET: Listar templates
- POST: Criar template

**`/api/evolution/templates/[id]/route.ts`**
- GET: Detalhes do template
- PUT: Atualizar template
- DELETE: Excluir template

**`/api/evolution/templates/upload/route.ts`**
- POST: Upload de imagens para templates

**`/api/evolution/messages/send/route.ts`**
- POST: Enviar mensagem (texto ou imagem)

**`/api/evolution/messages/history/route.ts`**
- GET: Hist√≥rico de mensagens (com filtros)

**`/api/evolution/webhook/route.ts`**
- POST: Receber webhooks da Evolution API

---

### **FASE 3: FRONTEND - INTERFACES ADMINISTRATIVAS**

#### 3.1 Configura√ß√µes da Evolution API
**Arquivo**: `app/admin/configuracoes/page.tsx` (extens√£o)

**Nova Aba: "WhatsApp Evolution"**
- Campo: URL da Evolution API
- Campo: API Key Global
- Bot√£o: Testar Conex√£o
- Status: Conectado/Desconectado

#### 3.2 Layout para √Årea Evolution
**Arquivo**: `app/admin/evolution/layout.tsx`

**Caracter√≠sticas:**
- Verifica√ß√£o de admin supremo
- Menu lateral espec√≠fico para Evolution
- Breadcrumb navega√ß√£o

#### 3.3 Gerenciador de Inst√¢ncias
**Arquivo**: `app/admin/evolution/instancias/page.tsx`

**Funcionalidades:**
- Lista de inst√¢ncias com status
- Bot√£o "Nova Inst√¢ncia"
- Modal QR Code
- A√ß√µes: Conectar, Desconectar, Excluir
- Atualiza√ß√£o em tempo real

**Arquivo**: `app/admin/evolution/instancias/nova/page.tsx`
- Formul√°rio para criar inst√¢ncia
- Valida√ß√£o de nome √∫nico
- Redirecionamento autom√°tico ap√≥s cria√ß√£o

#### 3.4 Templates de Mensagens
**Arquivo**: `app/admin/evolution/templates/page.tsx`

**Lista de Templates:**
- Filtros por tipo e status
- Visualiza√ß√£o tipo de mensagem (texto/imagem)
- Bot√µes de a√ß√£o (editar, excluir, ativar/desativar)

**Arquivo**: `app/admin/evolution/templates/novo/page.tsx`
**Arquivo**: `app/admin/evolution/templates/[id]/editar/page.tsx`

**Formul√°rio de Template:**
- Nome do template
- Tipo (vencimento, pagamento, etc.)
- Tipo de mensagem (texto/imagem)
- Editor de mensagem com vari√°veis
- Upload de imagem (se tipo imagem)
- Legenda da imagem
- Preview em tempo real

#### 3.5 Hist√≥rico de Mensagens
**Arquivo**: `app/admin/evolution/mensagens/page.tsx`

**Funcionalidades:**
- Filtros: cliente, per√≠odo, status, tipo
- Visualiza√ß√£o de imagens enviadas
- Detalhes da mensagem
- Status de entrega
- Reenvio de mensagens

#### 3.6 Dashboard WhatsApp
**Arquivo**: `app/admin/evolution/dashboard/page.tsx`

**Estat√≠sticas:**
- Total de mensagens enviadas
- Taxa de entrega
- Inst√¢ncias ativas/inativas
- Pr√≥ximos vencimentos a notificar
- Gr√°ficos de performance

---

### **FASE 4: INTEGRA√á√ÉO COM SISTEMA DE CLIENTES**

#### 4.1 Extens√£o da Lista de Clientes
**Arquivo**: `app/admin/clientes/page.tsx` (modifica√ß√£o)

**Novas Funcionalidades:**
- Coluna com bot√£o "WhatsApp"
- Modal para envio de mensagem
- Sele√ß√£o de template
- Preview antes do envio

#### 4.2 Sistema Autom√°tico de Vencimento
**Arquivo**: `lib/auto-whatsapp-notifications.ts`

**Caracter√≠sticas:**
- Cron job di√°rio
- Verifica√ß√£o de vencimentos pr√≥ximos
- Envio baseado em templates ativos
- Log de mensagens enviadas
- Configura√ß√£o de dias de anteced√™ncia

**Arquivo**: `app/api/cron/whatsapp-notifications/route.ts`
- Endpoint para execu√ß√£o manual/automatizada

---

### **FASE 5: COMPONENTES REUTILIZ√ÅVEIS**

#### 5.1 Componentes Core
**Arquivo**: `components/evolution-config.tsx`
- Formul√°rio de configura√ß√£o da Evolution API
- Teste de conex√£o
- Indicadores de status

**Arquivo**: `components/instance-manager.tsx`
- Lista de inst√¢ncias
- Cards com status
- A√ß√µes r√°pidas

**Arquivo**: `components/qr-code-modal.tsx`
- Modal para exibir QR Code
- Atualiza√ß√£o autom√°tica
- Instru√ß√µes de conex√£o

**Arquivo**: `components/template-form.tsx`
- Formul√°rio completo para templates
- Editor de texto com vari√°veis
- Upload de imagem
- Preview em tempo real

**Arquivo**: `components/message-sender.tsx`
- Modal para envio de mensagem
- Sele√ß√£o de template
- Personaliza√ß√£o de mensagem
- Preview final

**Arquivo**: `components/whatsapp-stats.tsx`
- Cards de estat√≠sticas
- Gr√°ficos de performance
- Indicadores visuais

#### 5.2 Componentes de Seguran√ßa
**Arquivo**: `components/admin-guard.tsx`
- HOC para prote√ß√£o de rotas
- Verifica√ß√£o de admin supremo
- Redirecionamento autom√°tico

---

## üì± **VARI√ÅVEIS DISPON√çVEIS NOS TEMPLATES**

### **Vari√°veis do Cliente:**
- `{nome}` - Nome do cliente
- `{whatsapp}` - WhatsApp do cliente
- `{usuario}` - Usu√°rio de acesso
- `{status}` - Status do cliente

### **Vari√°veis do Plano:**
- `{plano}` - Nome do plano
- `{valor_plano}` - Valor do plano
- `{data_ativacao}` - Data de ativa√ß√£o
- `{data_vencimento}` - Data de vencimento
- `{dias_vencimento}` - Dias at√© vencimento
- `{dias_desde_ativacao}` - Dias desde ativa√ß√£o

### **Vari√°veis do Servidor:**
- `{servidor}` - Nome do servidor

### **Vari√°veis do Sistema:**
- `{data_atual}` - Data atual
- `{hora_atual}` - Hora atual
- `{nome_sistema}` - Nome do sistema

---

## üîí **CONTROLE DE ACESSO E SEGURAN√áA**

### **Admin Supremo (ID = 1) - ACESSO TOTAL:**
- ‚úÖ Configura√ß√£o da Evolution API
- ‚úÖ Cria√ß√£o e gest√£o de inst√¢ncias
- ‚úÖ Templates de mensagem (texto e imagem)
- ‚úÖ Envio manual para clientes
- ‚úÖ Hist√≥rico completo de mensagens
- ‚úÖ Dashboard de estat√≠sticas
- ‚úÖ Configura√ß√µes de automa√ß√£o

### **Clientes - ISOLAMENTO COMPLETO:**
- ‚ùå Nenhuma funcionalidade de WhatsApp
- ‚ùå Nenhuma visualiza√ß√£o de mensagens
- ‚ùå Dashboard cliente inalterado
- ‚ùå Nenhuma notifica√ß√£o sobre WhatsApp

### **Verifica√ß√µes de Seguran√ßa:**
1. **Middleware em todas as rotas `/api/evolution/*`**
2. **Guard em todas as p√°ginas `/admin/evolution/*`**
3. **Verifica√ß√£o de sess√£o ativa**
4. **Valida√ß√£o de tipo de usu√°rio**
5. **Prote√ß√£o contra acesso direto**

---

## üöÄ **FLUXO DE IMPLEMENTA√á√ÉO**

### **Ordem de Desenvolvimento:**
1. **FASE 1**: Infraestrutura e banco de dados
2. **FASE 2**: APIs e comunica√ß√£o com Evolution
3. **FASE 3**: Interfaces administrativas
4. **FASE 4**: Integra√ß√£o com clientes
5. **FASE 5**: Componentes e otimiza√ß√µes

### **Crit√©rios de Aceita√ß√£o por Fase:**

**FASE 1 - COMPLETA QUANDO:**
- ‚úÖ Tabelas criadas no banco
- ‚úÖ Configura√ß√µes adicionadas
- ‚úÖ Middleware de seguran√ßa funcionando

**FASE 2 - COMPLETA QUANDO:**
- ‚úÖ Comunica√ß√£o com Evolution API funcionando
- ‚úÖ Todas as APIs respondendo corretamente
- ‚úÖ Webhook configurado e recebendo dados

**FASE 3 - COMPLETA QUANDO:**
- ‚úÖ Interface de configura√ß√£o funcionando
- ‚úÖ Gerenciador de inst√¢ncias operacional
- ‚úÖ CRUD de templates completo
- ‚úÖ Hist√≥rico de mensagens vis√≠vel

**FASE 4 - COMPLETA QUANDO:**
- ‚úÖ Bot√£o WhatsApp na lista de clientes
- ‚úÖ Envio manual funcionando
- ‚úÖ Sistema autom√°tico operacional

**FASE 5 - COMPLETA QUANDO:**
- ‚úÖ Todos os componentes reutiliz√°veis
- ‚úÖ Interface polida e responsiva
- ‚úÖ Performance otimizada

---

## üìä **ESTRUTURA DE ARQUIVOS FINAL**

```
projeto/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ EVOLUTION_API_PLAN.md          # Este documento
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ evolution-api.ts               # Comunica√ß√£o com Evolution API
‚îÇ   ‚îú‚îÄ‚îÄ auto-whatsapp-notifications.ts # Sistema autom√°tico
‚îÇ   ‚îú‚îÄ‚îÄ whatsapp-templates.ts          # Processamento de templates
‚îÇ   ‚îî‚îÄ‚îÄ admin-middleware.ts            # Verifica√ß√£o admin supremo
‚îú‚îÄ‚îÄ app/api/evolution/
‚îÇ   ‚îú‚îÄ‚îÄ config/route.ts                # Configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ instances/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts                   # CRUD inst√¢ncias
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ route.ts               # Inst√¢ncia espec√≠fica
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ qr/route.ts           # QR Code
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ status/route.ts       # Status
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts                   # CRUD templates
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [id]/route.ts             # Template espec√≠fico
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload/route.ts           # Upload imagens
‚îÇ   ‚îú‚îÄ‚îÄ messages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ send/route.ts             # Envio mensagens
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ history/route.ts          # Hist√≥rico
‚îÇ   ‚îî‚îÄ‚îÄ webhook/route.ts              # Webhook Evolution
‚îú‚îÄ‚îÄ app/admin/evolution/              # √Årea exclusiva admin supremo
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx                    # Layout com verifica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ instancias/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Lista inst√¢ncias
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nova/page.tsx            # Nova inst√¢ncia
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/page.tsx            # Detalhes inst√¢ncia
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx                  # Lista templates
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ novo/page.tsx            # Novo template
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/editar/page.tsx     # Editar template
‚îÇ   ‚îú‚îÄ‚îÄ mensagens/page.tsx           # Hist√≥rico mensagens
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/page.tsx           # Dashboard WhatsApp
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ evolution-config.tsx          # Config Evolution API
‚îÇ   ‚îú‚îÄ‚îÄ instance-manager.tsx          # Gerenciador inst√¢ncias
‚îÇ   ‚îú‚îÄ‚îÄ template-form.tsx            # Formul√°rio templates
‚îÇ   ‚îú‚îÄ‚îÄ message-sender.tsx           # Envio mensagens
‚îÇ   ‚îú‚îÄ‚îÄ qr-code-modal.tsx            # Modal QR Code
‚îÇ   ‚îú‚îÄ‚îÄ whatsapp-stats.tsx           # Estat√≠sticas
‚îÇ   ‚îî‚îÄ‚îÄ admin-guard.tsx              # Guard admin supremo
‚îî‚îÄ‚îÄ public/uploads/whatsapp/         # Diret√≥rio para imagens
    ‚îî‚îÄ‚îÄ templates/                    # Imagens dos templates
```

---

## üéØ **CONSIDERA√á√ïES FINAIS**

### **Benef√≠cios da Implementa√ß√£o:**
- üì± Comunica√ß√£o direta com clientes via WhatsApp
- ü§ñ Automa√ß√£o de notifica√ß√µes de vencimento
- üìä Controle total sobre mensagens enviadas
- üîí Seguran√ßa com isolamento completo do cliente
- üìà Melhoria na reten√ß√£o de clientes

### **Tecnologias Utilizadas:**
- **Evolution API v2** - Comunica√ß√£o WhatsApp
- **Next.js** - Framework React
- **MySQL** - Banco de dados
- **TypeScript** - Tipagem est√°tica
- **Tailwind CSS** - Estiliza√ß√£o

### **Tempo Estimado de Implementa√ß√£o:**
- **FASE 1**: 1-2 dias
- **FASE 2**: 2-3 dias
- **FASE 3**: 3-4 dias
- **FASE 4**: 1-2 dias
- **FASE 5**: 1-2 dias
- **TOTAL**: 8-13 dias

---

**Documento criado em**: Janeiro 2025  
**Vers√£o**: 1.0  
**Status**: Aprovado para implementa√ß√£o 